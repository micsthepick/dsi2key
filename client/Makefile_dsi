#---------------------------------------------------------------------------------
.SUFFIXES:
#---------------------------------------------------------------------------------
ifeq ($(strip $(DEVKITARM)),)
$(error "Please set DEVKITARM in your environment. export DEVKITARM=<path to>devkitARM")
endif

include $(DEVKITARM)/ds_rules

export TARGET		:=	ds2key
export TOPDIR		:=	$(CURDIR)


.PHONY: $(TARGET).arm7.elf $(TARGET).arm9.elf

#---------------------------------------------------------------------------------
# main targets
#---------------------------------------------------------------------------------
all: $(TARGET).dsi

#---------------------------------------------------------------------------------
$(TARGET).dsi	:	$(TARGET).arm7.elf $(TARGET).arm9.elf
	ndstool	-c $(TARGET).dsi -7 $(TARGET).arm7.elf -9 $(TARGET).arm9.elf -g DK2E 00 DSI2KEY 1 -o icon.bmp -b icon.bmp "DSI2KEY;Use DSI as PC remote;- Sypherce, mics"
	cat $(TARGET).arm7.sym $(TARGET).arm9.sym | uniq | grep -E '.+ .+' > $(TARGET).sym

#---------------------------------------------------------------------------------
$(TARGET).arm7.elf:
	$(MAKE) -f Makefile_arm7
	$(DEVKITARM)/bin/arm-none-eabi-nm -n $(TARGET).arm7.elf > $(TARGET).arm7.raw.sym
	sed -r 's/([0-9a-fA-F]{8}) [a-zA-Z] (.*)/\1 \2/g' $(TARGET).arm7.raw.sym > $(TARGET).arm7.sym
	rm $(TARGET).arm7.raw.sym

#---------------------------------------------------------------------------------
$(TARGET).arm9.elf:
	$(MAKE) -f Makefile_arm9
	$(DEVKITARM)/bin/arm-none-eabi-nm -n $(TARGET).arm9.elf > $(TARGET).arm9.raw.sym
	sed -r 's/([0-9a-fA-F]{8}) [a-zA-Z] (.*)/\1 \2/g' $(TARGET).arm9.raw.sym > $(TARGET).arm9.sym
	rm $(TARGET).arm9.raw.sym

#---------------------------------------------------------------------------------
clean:
	$(MAKE) -f Makefile_arm9 clean
	$(MAKE) -f Makefile_arm7 clean
	rm -f $(TARGET).dsi $(TARGET).arm7 $(TARGET).arm9

